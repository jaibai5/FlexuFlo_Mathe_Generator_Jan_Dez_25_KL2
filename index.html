<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Mathe Generator V30.3 (Better School Font)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Mali:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           CSS - DESIGN UND FARBEN
           ========================================= */
        :root {
            --text-color: #000;
            --line-color: #000;
            --sol-color: #d60000; /* Farbe der L√∂sungen (Rot) */
            --sol-bg: #ffcccc;    /* Hintergrund der L√∂sungen */
            --arc-blue: #007acc;  /* Farbe der Rechenb√∂gen (Blau) */
            --grid-line: #bbb;    /* Farbe der Karok√§stchen */
            --input-bg: rgba(255, 255, 0, 0.1); /* Gelber Hintergrund f√ºr Eingabefelder */
        }

        body.ink-saver-mode {
            --sol-color: #000;    
            --sol-bg: #e0e0e0; 
            --arc-blue: #444;     
        }

        /* --- ALLGEMEINE SEITEN-EINSTELLUNGEN --- */
        body { 
            /* Standard-Schrift f√ºr Text ist Andika */
            font-family: 'Andika', sans-serif; 
            background-color: #555; 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }
        
        /* Das wei√üe Blatt Papier */
        .page { 
            background: white; 
            width: 210mm; min-height: 297mm; /* A4 Format */
            padding: 8mm 15mm; 
            box-sizing: border-box; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); 
            position: relative; margin-bottom: 20px; 
            overflow: hidden; 
            color: var(--text-color); 
        }
        
        .page.hidden-page { display: none; }

        /* Verhalten beim Bearbeiten */
        [contenteditable="true"]:hover { background-color: rgba(255, 230, 0, 0.15); cursor: text; outline: 1px dotted #999; }
        [contenteditable="true"]:focus { background-color: rgba(255, 230, 0, 0.3); outline: none; }

        /* --- ZAHLEN-DESIGN (NEUE SCHRIFTART) --- */
        /* Wir nutzen 'Mali' f√ºr alles, was Zahlen sind, damit die 4 offen ist und die 7 deutlich */
        input.live-num, 
        .grid-text, 
        .tick-label, 
        .brick, 
        .packet-item,
        input.gap-input,
        input.brick-input,
        .arc-label,
        .arc-big-label,
        .answer-sol-text {
            font-family: 'Mali', cursive; /* Handschriftlicher Look */
        }

        /* --- EINGABEFELDER --- */
        input.live-num { 
            font-size: inherit; font-weight: bold; 
            color: inherit; background: var(--input-bg); 
            border: 1px dotted #ccc; border-radius: 3px; 
            text-align: center; width: 2.5ch; padding: 0 2px; 
            -moz-appearance: textfield; 
        }
        input.live-num:focus { background: #fff; outline: 2px solid #007acc; border-color: transparent; }
        input.live-num.story-input { width: 4ch; display: inline-block; vertical-align: baseline; }
        input.live-num.wide-input { width: 5ch; } 
        
        /* Spezielle Inputs f√ºr L√ºckenaufgaben */
        input.gap-input { 
            width: 6ch; height: 30px; 
            border-bottom: 2px solid #000; border-top:none; border-left:none; border-right:none; 
            background: var(--input-bg); border-radius: 0; 
            text-align: center; font-weight: bold; color: inherit; 
            font-size: 22px;
        }
        
        .packet-item input.live-num { font-size: 22px; width: 5ch; height: 30px; }

        /* Spezielle Inputs f√ºr Mauersteine */
        input.brick-input { 
            width: 90%; height: 90%; border: none; 
            background: var(--input-bg); 
            text-align: center; font-size: 16px; font-weight: bold; 
        }
        input.brick-input:focus { outline: 2px solid #007acc; background: #fff; }

        /* --- STEUERMEN√ú (LINKS) --- */
        .controls { 
            position: fixed; top: 20px; left: 20px; width: 270px; 
            background: #fff; padding: 20px; padding-bottom: 70px; 
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; 
            max-height: 90vh; overflow-y: auto; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column;
        }
        .controls h3 { margin-top: 0; margin-bottom: 15px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .version-footer { margin-top: 20px; font-size: 11px; color: #999; font-style: italic; text-align: center; }
        
        .nav-label-xl { font-size: 16px; font-weight: 900; color: #000; margin-bottom: 8px; text-transform: uppercase; border-bottom: 2px solid #ffcc00; display: inline-block; }
        .nav-label { font-size: 12px; font-weight: bold; color: #666; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .checkbox-container { display: flex; align-items: center; margin-bottom: 20px; background: #eee; padding: 10px; border-radius: 5px; }
        .checkbox-container input { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        select { width: 100%; padding: 8px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; font-weight: bold; color: #333; cursor: pointer; }
        .tab-btn { display: block; width: 100%; padding: 8px; margin-bottom: 5px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; background: #f0f0f0; text-align: left; }
        .tab-btn.active { background-color: #007acc; color: white; border-color: #005fa3; font-weight: bold; }
        
        .action-btn { display: block; width: 100%; padding: 12px; margin-bottom: 10px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; text-align: center; text-decoration: none; box-sizing: border-box; }
        .btn-roll { background-color: #ffcc00; color: #333; margin-top: 15px; }
        .btn-print { background-color: #28a745; color: white; }
        .btn-help { background-color: #17a2b8; color: white; margin-top: 5px; }
        .btn-reset { background-color: #ddd; color: #333; font-size: 12px; padding: 5px; margin-top:10px; }
        .btn-feedback { background-color: #6c757d; color: white; font-size: 14px; margin-top: 5px; }

        /* --- HILFE MODAL (POPUP) --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 600px; max-width: 90%; padding: 25px; border-radius: 10px; font-family: 'Segoe UI', sans-serif; overflow-y: auto; max-height: 90vh; }
        .close-modal { background: #d60000; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; font-weight: bold; }
        .modal-box h4 { margin-top: 15px; margin-bottom: 5px; color: #007acc; border-bottom: 1px solid #eee; }
        .modal-box ul { padding-left: 20px; margin-top: 5px; }
        .modal-box li { margin-bottom: 5px; font-size: 14px; }
        .modal-box p { margin-bottom: 10px; line-height: 1.4; color: #333; }

        /* --- FORMATIERUNG AUF DEM BLATT --- */
        .solution-mark { position: absolute; top: 10mm; right: 10mm; font-size: 20px; font-weight: bold; color: var(--sol-color); border: 2px solid var(--sol-color); padding: 5px 10px; transform: rotate(15deg); opacity: 0.8; }
        .sol { color: var(--sol-color); font-weight: bold; transition: color 0.3s; }
        
        .header-title { text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; border-bottom: 3px double #000; padding-bottom: 1px; margin-bottom: 5px; letter-spacing: 1px; }
        .meta-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 16px; font-weight: 500; }
        .line { display: inline-block; border-bottom: 1px solid #000; height: 18px; }
        .test-number { font-weight: bold; font-size: 18px; color: #333; padding-left: 5px; }
        h2 { font-size: 15px; margin: 0 0 3px 0; padding-left: 10px; border-left: 6px solid #ddd; text-transform: uppercase; color: #333; }
        
        /* ABST√ÑNDE */
        .task-row-mix { margin-bottom: 15px; } 
        .task-row-steps { margin-bottom: 55px; }
        .task-row-lines { margin-bottom: 50px; }
        .task-row-walls { margin-bottom: 30px; } 
        .task-row-sym { margin-bottom: 40px; }
        .task-row-story { margin-bottom: 30px; } 
        
        /* Flex/Flo Style f√ºr P√§ckchen */
        .packet-container { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; margin-top: 20px; }
        .packet { width: 48%; margin-bottom: 30px; background: #fdfdfd; border: 2px solid #eee; border-radius: 10px; padding: 15px 10px; padding-top: 35px; box-sizing: border-box; position: relative; }
        .packet-label { position: absolute; top: 5px; left: 10px; font-weight: bold; color: #000; font-size: 18px; }
        .packet-item { font-size: 22px; font-weight: 500; margin-bottom: 12px; display: flex; align-items: center; justify-content: flex-start; padding-left: 10px; }
        
        .header-spacer { height: 30px; width: 100%; }
        .top-margin-large { margin-top: 40px; }
        .footer-info { position: absolute; bottom: 8mm; left: 0; width: 100%; text-align: center; font-size: 11px; color: #999; font-style: italic; }

        /* --- LAYOUTS --- */
        .side-layout { display: flex; flex-direction: row; align-items: center; justify-content: center; margin-bottom: 10px; }
        .side-label { font-weight: bold; margin-right: 15px; font-size: 16px; width: 30px; min-width: 30px; text-align: right; display: block; flex-shrink: 0; }
        .sub-label { font-weight: bold; margin-right: 5px; display: inline-block; }

        /* Symmetrie */
        .sym-wrapper { display: flex; flex-direction: row; justify-content: center; gap: 40px; width: 100%; }
        .sym-box { display: flex; flex-direction: column; align-items: center; }
        .sym-table { border-collapse: collapse; border: 2px solid #000; background: #fff; }
        .sym-table td { width: 20px; height: 20px; border: 1px solid #999; padding: 0; cursor: pointer; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        .axis-border { border-right: 3px solid #000 !important; }
        .filled-cell { background-color: #555 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .solution-cell { background-color: var(--sol-bg) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

        /* Raster */
        .grid-paper { background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px); background-size: 20px 20px; border: 2px solid #666; width: 100%; height: 122px; position: relative; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        .grid-text { font-size: 22px; font-weight: 600; letter-spacing: 3px; line-height: 40px; position: absolute; top: -2px; left: 8px; background-color: rgba(255,255,255,0.6); padding: 0 5px; white-space: pre-wrap; }

        /* Mauern */
        .walls-wrapper { display: flex; justify-content: space-around; padding: 0; }
        .wall { display: flex; flex-direction: column; align-items: center; }
        .brick-row { display: flex; }
        .brick { width: 45px; height: 24px; border: 2px solid #000; margin: 2px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; background: #fff; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        
        .number-line-box { margin-bottom: 5px; position: relative; } 
        .number-line { width: 95%; height: 75px; border-bottom: 2px solid #000; position: relative; margin: 0 auto; margin-top: 20px; }
        .number-line::after { content: ""; position: absolute; right: -2px; bottom: -6px; width: 0; height: 0; border-left: 10px solid #000; border-top: 5px solid transparent; border-bottom: 5px solid transparent; }
        .tick { position: absolute; bottom: 0; width: 3px; height: 10px; background: #000; transition: left 0.3s; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        .tick-label { position: absolute; top: 12px; transform: translateX(-50%); font-size: 16px; font-weight: bold; transition: left 0.3s; white-space: nowrap;}
        .tick-sol { background: var(--sol-color); height: 10px; z-index: 2; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        .tick-label-sol { color: var(--sol-color); }
        .arc { position: absolute; bottom: 2px; border-top: 2px solid var(--sol-color); border-left: 2px solid var(--sol-color); border-right: 2px solid var(--sol-color); border-top-left-radius: 20px; border-top-right-radius: 20px; height: 25px; box-sizing: border-box; border-bottom: none; z-index: 5; transition: all 0.3s; }
        .arc-label { position: absolute; top: -22px; width: 100%; text-align: center; color: var(--sol-color); font-size: 13px; font-weight: bold; }
        .arc-big { position: absolute; bottom: 2px; border-top: 2px solid var(--arc-blue); border-left: 2px solid var(--arc-blue); border-right: 2px solid var(--arc-blue); border-top-left-radius: 30px; border-top-right-radius: 30px; height: 50px; box-sizing: border-box; border-bottom: none; z-index: 4; transition: all 0.3s; }
        .arc-big-label { position: absolute; top: -25px; width: 100%; text-align: center; color: var(--arc-blue); font-size: 14px; font-weight: bold; }

        .story-text { font-size: 16px; line-height: 1.3; margin-bottom: 3px; }
        .label-small { font-size: 12px; color: #555; font-style: italic; margin-bottom: 2px; }
        .answer-sol-text { color: var(--sol-color); margin-left: 10px; font-size: 16px; }

        /* --- DRUCK-MODUS --- */
        @page { size: A4; margin: 0mm; }
        @media print {
            body { background: none; display: block; margin: 0; padding: 0; }
            .controls, .modal-overlay { display: none !important; }
            [contenteditable="true"] { outline: none !important; background-color: transparent !important; }
            input.live-num { border: none !important; background: transparent !important; padding: 0 !important; -webkit-appearance: none; margin: 0; }
            input.brick-input { background: transparent !important; }
            input.gap-input { border-bottom: 2px solid #000 !important; background: transparent !important; -webkit-appearance: none; }
            input.gap-field { color: transparent !important; text-shadow: none !important; }
            .packet { background: transparent; border: none; padding: 0; padding-top: 30px; margin-bottom: 20px; } 
            .packet-label { top: 0; left: 0; }
            .page { width: 210mm; height: 296mm; margin: 0; padding: 8mm 15mm; border: none; box-shadow: none; zoom: 1.0; page-break-after: always; break-after: page; display: block !important; overflow: hidden; }
            .page.hidden-page { display: none !important; }
            .page:last-child { page-break-after: avoid; break-after: avoid; }
        }
    </style>
</head>
<body>

    <div class="modal-overlay" id="helpModal">
        <div class="modal-box">
            <button class="close-modal" onclick="closeHelp()">X</button>
            <h2>Hilfe & Anleitung</h2>
            <p>Willkommen beim <strong>Mathe Generator f√ºr Klasse 2</strong>.</p>
            
            <h4>Das Men√º (Links)</h4>
            <ul>
                <li><strong>Mathe Test:</strong> Erstellt einen gemischten Test (2 Seiten).</li>
                <li><strong>√úbungsaufgaben:</strong> Erstellt ein ganzes Blatt nur zu einem Thema.</li>
            </ul>

            <h4>Wichtig: Zahlen √§ndern!</h4>
            <p>Sie sehen viele <strong>gelbe Felder</strong> auf dem Blatt? Da k√∂nnen Sie reinklicken!</p>
            <ul>
                <li>Klicken Sie auf eine Zahl, die Ihnen nicht gef√§llt.</li>
                <li>Schreiben Sie eine neue Zahl hinein.</li>
                <li>Die L√∂sung (auf dem zweiten Blatt) rechnet sich <strong>automatisch</strong> neu aus.</li>
            </ul>

            <h4>Tipps zum Drucken</h4>
            <ul>
                <li>Klicken Sie auf den gr√ºnen Knopf <strong>"Drucken"</strong>.</li>
                <li>Es werden immer zwei Bl√§tter gedruckt: Das Aufgabenblatt f√ºr das Kind und das L√∂sungsblatt f√ºr die Eltern (zur Kontrolle).</li>
                <li><strong>Tintenspar-Modus:</strong> Wenn Sie das anklicken, wird alles in Schwarz/Wei√ü gedruckt, um Farbe zu sparen.</li>
            </ul>

            <h4>Die Aufgabentypen</h4>
            <ul>
                <li><strong>1. Rechenschritte:</strong> Zerlegung in Zehnerschritte (z.B. 45+8 &#8594; 45+5+3).</li>
                <li><strong>2. Rechenstrich:</strong> Anschauliches Rechnen mit B√∂gen am Strich.</li>
                <li><strong>3. Rechenmauern:</strong> Der obere Stein ist die Summe der beiden unteren.</li>
                <li><strong>4. Rechengeschichten:</strong> Textaufgaben, bei denen sich die Zahlen automatisch anpassen.</li>
                <li><strong>5. Symmetrie:</strong> Muster im Raster spiegeln (interaktiv durch Klicken!).</li>
                <li><strong>6. Kopfrechnen:</strong> Klassische P√§ckchenaufgaben.</li>
                <li><strong>7. L√ºckenaufgaben:</strong> Platzhalteraufgaben zum Erg√§nzen.</li>
            </ul>
        </div>
    </div>

    <div class="controls">
        <h3>Mathe Generator</h3>
        <div class="nav-label-xl">Modus W√§hlen</div>
        <button class="tab-btn active" onclick="switchMode('mix', this)">üìã Mathe Test</button>
        <div class="nav-label" style="margin-top:15px;">√úbungsaufgaben:</div>
        <button class="tab-btn" onclick="switchMode('steps', this)">1. Rechenschritte</button>
        <button class="tab-btn" onclick="switchMode('lines', this)">2. Rechenstrich</button>
        <button class="tab-btn" onclick="switchMode('walls', this)">3. Rechenmauern</button>
        <button class="tab-btn" onclick="switchMode('sym', this)">4. Symmetrie</button>
        <button class="tab-btn" onclick="switchMode('story', this)">5. Sachaufgaben</button>
        <button class="tab-btn" onclick="switchMode('mental', this)">6. Kopfrechnen</button>
        <button class="tab-btn" onclick="switchMode('gaps', this)">7. L√ºckenaufgaben</button>
        
        <hr style="margin: 25px 0 15px 0; border: 0; border-top: 1px solid #ddd;">
        <div class="nav-label">Aufgabentyp (Logik):</div>
        <select id="diff-select" onchange="triggerRecalcAll()">
            <option value="easy">ZE ¬± E (Zehner√ºbergang)</option>
            <option value="hard">ZE ¬± ZE (Schrittweise)</option>
        </select>
        <div class="checkbox-container">
            <input type="checkbox" id="ink-saver" onchange="toggleInkSaver()">
            <label for="ink-saver">Tintenspar-Modus</label>
        </div>
        <button class="action-btn btn-roll" onclick="generateCurrent(true)">üé≤ Neu W√ºrfeln</button>
        <button class="action-btn btn-help" onclick="openHelp()">‚ùì Hilfe & Anleitung</button>
        <button class="action-btn btn-print" onclick="window.print()">üñ®Ô∏è Drucken / PDF</button>
        <button class="btn-reset" onclick="resetCounter()">Z√§hler Reset</button>

        <hr style="margin: 25px 0 15px 0; border: 0; border-top: 1px solid #ddd;">
        <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:5px; text-align:center;">Gerne Fehler/Bugs und Feedback melden:</div>
        <a href="mailto:mark@simsoft.de" class="action-btn btn-feedback">‚úâÔ∏è E-Mail an Mark</a>

        <div class="version-footer">
            Vorbereitung Mathe Klasse 2 (Flex & Flo) - V30.3
        </div>
    </div>

    <div class="page" id="page-student">
        <div class="header-title" id="sheet-title" contenteditable="true">Mathe Test (Teil 1)</div>
        <div class="meta-info">
            <div style="width: 40%;">Name: <span class="line" style="width: 70%;"></span></div>
            <div style="width: 30%;">Datum: <span class="line" style="width: 60%;"></span></div>
            <div style="width: 20%; text-align: right;">Nr.: <span class="test-nr-display test-number" contenteditable="true">1</span></div>
        </div>
        <div id="student-content"></div>
    </div>

    <div class="page hidden-page" id="page-student-2">
        <div class="header-title" contenteditable="true">Mathe Test (Teil 2)</div>
        <div class="meta-info">
            <div style="width: 40%;">Name: <span class="line" style="width: 70%;"></span></div>
            <div style="width: 30%;"></div>
            <div style="width: 20%; text-align: right;">Nr.: <span class="test-nr-display test-number">1</span></div>
        </div>
        <div id="student-content-2"></div>
    </div>

    <div class="page" id="page-solution">
        <div class="solution-mark">L√ñSUNGSBLATT</div>
        <div class="header-title" id="sheet-title-sol" contenteditable="true">Mathe Test (Teil 1) (L√∂sung)</div>
        <div class="meta-info">
            <div style="width: 40%;">Name: <span class="line" style="border:none; width: 70%; font-style:italic; color:#999;">Musterl√∂sung</span></div>
            <div style="width: 30%;">Datum: <span class="line" style="border:none; width: 60%;"></span></div>
            <div style="width: 20%; text-align: right;">Nr.: <span class="test-nr-display test-number" style="color:var(--sol-color)" contenteditable="true">1</span></div>
        </div>
        <div id="solution-content"></div>
    </div>

    <div class="page hidden-page" id="page-solution-2">
        <div class="solution-mark">L√ñSUNGSBLATT</div>
        <div class="header-title" contenteditable="true">Mathe Test (Teil 2) (L√∂sung)</div>
        <div class="meta-info">
            <div style="width: 40%;">Name: <span class="line" style="border:none; width: 70%; font-style:italic; color:#999;">Musterl√∂sung</span></div>
            <div style="width: 30%;"></div>
            <div style="width: 20%; text-align: right;">Nr.: <span class="test-nr-display test-number" style="color:var(--sol-color)">1</span></div>
        </div>
        <div id="solution-content-2"></div>
    </div>

    <script>
        let currentNr = 1; 
        let currentMode = 'mix'; 
        let uniqueIdCounter = 0;
        
        // Zwischenspeicher, damit Aufgaben beim Tab-Wechsel erhalten bleiben
        let appCache = {};

        // --- SICHERER ZUFALLSGENERATOR ---
        // Verhindert Endlosschleifen und Abst√ºrze, wenn keine Zahl gefunden wird.
        function getSafeRandom(min, max, conditionFn, fallback) {
            let tries = 0;
            if (min > max) { let temp = min; min = max; max = temp; }
            while (tries < 20) {
                let n = Math.floor(Math.random() * (max - min + 1)) + min;
                if(conditionFn(n)) return n;
                tries++;
            }
            return fallback;
        }
        function rand(min, max) { 
            if (min > max) { let temp = min; min = max; max = temp; }
            return Math.floor(Math.random() * (max - min + 1)) + min; 
        }

        const ALL_STORIES = [
            { t: "Auf dem Pausenhof spielen {A} Kinder Fangen. {B} Kinder kommen dazu. Wie viele spielen jetzt?", op: "+", u: "Kinder" },
            { t: "Im Bus sitzen {A} Fahrg√§ste. An der Haltestelle steigen {B} Personen aus. Wie viele sind noch im Bus?", op: "-", u: "Personen" },
            { t: "Lina hat {A} Muscheln gesammelt. Tim schenkt ihr noch {B} Muscheln. Wie viele hat sie nun?", op: "+", u: "Muscheln" },
            { t: "In der T√ºte waren {A} Bonbons. Die Klasse hat {B} aufgegessen. Wie viele sind √ºbrig?", op: "-", u: "Bonbons" },
            { t: "Im Regal stehen {A} B√ºcher. Frau M√ºller stellt {B} neue B√ºcher hinein. Wie viele B√ºcher sind es jetzt?", op: "+", u: "B√ºcher" },
            { t: "Max hat {A} Euro gespart. Er kauft ein Spielzeug f√ºr {B} Euro. Wie viel Geld bleibt √ºbrig?", op: "-", u: "Euro" },
            { t: "Auf dem gro√üen Parkplatz stehen {A} Autos. {B} Autos fahren weg. Wie viele stehen noch dort?", op: "-", u: "Autos" },
            { t: "In der Kiste liegen {A} √Ñpfel. F√ºr einen Kuchen werden {B} √Ñpfel genommen. Wie viele bleiben √ºbrig?", op: "-", u: "√Ñpfel" },
            { t: "Tom baut einen Turm mit {A} Bausteinen. Leo setzt noch {B} Steine oben drauf. Wie viele sind es?", op: "+", u: "Bausteine" },
            { t: "Auf dem Baum sitzen {A} V√∂gel. {B} V√∂gel fliegen weg. Wie viele V√∂gel sitzen noch dort?", op: "-", u: "V√∂gel" },
            { t: "Im Blumenladen stehen {A} Rosen. Die Verk√§uferin stellt {B} Tulpen dazu. Wie viele Blumen sind es?", op: "+", u: "Blumen" },
            { t: "Lisa hat {A} Sticker in ihrem Heft. Sie bekommt {B} neue Sticker geschenkt. Wie viele hat sie jetzt?", op: "+", u: "Sticker" },
            { t: "Das Buch hat {A} Seiten. Tim hat schon {B} Seiten gelesen. Wie viele Seiten fehlen noch?", op: "-", u: "Seiten" },
            { t: "In der Klasse sind {A} Kinder. Heute sind {B} Kinder krank. Wie viele Kinder sind in der Schule?", op: "-", u: "Kinder" }
        ];

        function getUniqueId() { return 'task_' + (uniqueIdCounter++); }
        function getLabel(index, mode) { return (mode === 'mix') ? String.fromCharCode(97 + (index % 2)) + ")" : String.fromCharCode(97 + index) + ")"; }
        function toggleInkSaver() { document.body.classList.toggle('ink-saver-mode'); }
        function openHelp() { document.getElementById('helpModal').style.display = 'flex'; }
        function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }

        function makeFieldsEditable() {
            document.querySelectorAll('.story-text, .grid-text, .tick-label, .brick, .arc-label, .arc-big-label, .answer-sol-text, h2, .header-title, .test-number, .sub-label, .side-label').forEach(el => {
                el.contentEditable = "true";
                el.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.execCommand('insertLineBreak'); }});
            });
        }

        // Leert den Cache (Zwischenspeicher) und erzwingt neue Zahlen
        function clearCacheAndRecalc() {
            appCache = {};
            generateCurrent(true); 
        }

        function switchMode(mode, btnElement) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            const titles = { 
                'mix': 'Mathe Test (Teil 1)', 'steps': '√úbungsblatt: Rechenschritte', 'lines': '√úbungsblatt: Rechenstrich', 
                'walls': '√úbungsblatt: Rechenmauern', 'sym': '√úbungsblatt: Symmetrie', 'story': '√úbungsblatt: Sachaufgaben', 
                'mental': '√úbungsblatt: Kopfrechnen', 'gaps': '√úbungsblatt: L√ºckenaufgaben'
            };
            document.getElementById('sheet-title').innerText = titles[mode];
            document.getElementById('sheet-title-sol').innerText = titles[mode] + " (L√∂sung)";
            
            if(mode === 'mix') {
                document.getElementById('page-student-2').classList.remove('hidden-page');
                document.getElementById('page-solution-2').classList.remove('hidden-page');
            } else {
                document.getElementById('page-student-2').classList.add('hidden-page');
                document.getElementById('page-solution-2').classList.add('hidden-page');
            }
            generateCurrent(false);
        }

        function generateCurrent(forceNew = false) {
            if (forceNew) {
                if(currentMode === 'mix') updateTestNumber();
                appCache[currentMode] = null;
            } else {
                loadInitialNumber();
            }

            const sCont1 = document.getElementById('student-content');
            const tCont1 = document.getElementById('solution-content');
            const sCont2 = document.getElementById('student-content-2');
            const tCont2 = document.getElementById('solution-content-2');

            // --- PR√úFE CACHE ---
            if (!forceNew && appCache[currentMode]) {
                let c = appCache[currentMode];
                sCont1.innerHTML = c.s1;
                sCont2.innerHTML = c.s2;
                tCont1.innerHTML = c.t1;
                tCont2.innerHTML = c.t2;
                c.listeners.forEach(fn => fn());
                triggerRecalcAll();
                makeFieldsEditable();
                return; 
            }

            // --- NEUE AUFGABEN GENERIEREN ---
            sCont1.innerHTML = ''; tCont1.innerHTML = '';
            sCont2.innerHTML = ''; tCont2.innerHTML = '';
            
            const difficulty = document.getElementById('diff-select').value;
            let currentStoryPool = [...ALL_STORIES]; 
            let accumulatedListeners = [];

            const addTaskTo = (targetS, targetT, generatorFunc, extraSpace, rowIdx, ...args) => {
                try {
                    let id = getUniqueId();
                    let taskObj = generatorFunc(id, extraSpace, difficulty, rowIdx, ...args);
                    let divS = document.createElement('div'); divS.innerHTML = taskObj.student;
                    let divT = document.createElement('div'); divT.innerHTML = taskObj.teacher;
                    targetS.appendChild(divS); targetT.appendChild(divT);
                    if (taskObj.registerListeners) {
                        taskObj.registerListeners(); 
                        accumulatedListeners.push(taskObj.registerListeners); 
                    }
                } catch(e) { console.error("Error generating task", e); }
            };
            const addTask = (generatorFunc, extraSpace, rowIdx, ...args) => addTaskTo(sCont1, tCont1, generatorFunc, extraSpace, rowIdx, ...args);

            if (currentMode === 'mix') {
                addTaskTo(sCont1, tCont1, genStepTask, false, null); 
                addTaskTo(sCont1, tCont1, genLineTask, false, null); 
                addTaskTo(sCont1, tCont1, genWallTask, false, null);
                addTaskTo(sCont1, tCont1, genStoryTask, false, null, currentStoryPool, "4. Rechengeschichten", "a)", "140px");
                
                addTaskTo(sCont2, tCont2, genSymTask, false, null, "5. Zeichne das Spiegelbild");
                
                let header6 = document.createElement('h2'); header6.innerText = "6. Kopfrechnen";
                let header6T = document.createElement('h2'); header6T.innerText = "6. Kopfrechnen";
                sCont2.appendChild(header6); tCont2.appendChild(header6T);
                addTaskTo(sCont2, tCont2, genMentalTask, false, null, 8); 

                let header7 = document.createElement('h2'); header7.innerText = "7. L√ºckenaufgaben";
                let header7T = document.createElement('h2'); header7T.innerText = "7. L√ºckenaufgaben";
                sCont2.appendChild(header7); tCont2.appendChild(header7T);
                addTaskTo(sCont2, tCont2, genGapTask, false, null, 10);
            } 
            else if (currentMode === 'steps') { for(let i=0; i<5; i++) addTask(genStepTask, true, i); }
            else if (currentMode === 'lines') { for(let i=0; i<3; i++) addTask(genLineTask, true, i); }
            else if (currentMode === 'walls') { for(let i=0; i<6; i++) addTask(genWallTask, true, i); } 
            else if (currentMode === 'sym') { for(let i=0; i<5; i++) addTask(genSymTask, true, i); }
            else if (currentMode === 'story') { for(let i=0; i<4; i++) addTask(genStoryTask, true, i, currentStoryPool, "", "", "90px"); }
            else if (currentMode === 'mental') { addTask(genMentalTask, true, null, 32); }
            else if (currentMode === 'gaps') { addTask(genGapTask, true, null, 30); } 
            
            makeFieldsEditable();

            // IN CACHE SPEICHERN
            appCache[currentMode] = {
                s1: sCont1.innerHTML,
                s2: sCont2.innerHTML,
                t1: tCont1.innerHTML,
                t2: tCont2.innerHTML,
                listeners: accumulatedListeners
            };
        }

        function triggerRecalcAll() { document.querySelectorAll('input.live-num').forEach(inp => { inp.dispatchEvent(new Event('input')); }); }

        // ========================
        // 1. RECHENSCHRITTE
        // ========================
        function genStepTask(id, extraSpace, diff, rowIdx) {
            let labelL = (rowIdx === null) ? 'a)' : getLabel(rowIdx * 2, 'practice');
            let labelR = (rowIdx === null) ? 'b)' : getLabel(rowIdx * 2 + 1, 'practice');
            let a1, a2, b1, b2;

            if (diff === 'easy') { 
                a1 = getSafeRandom(15, 75, n => (n%10 !== 0 && n%10 !== 1), 25);
                let maxA2 = 10 - (a1%10);
                a2 = getSafeRandom(maxA2 + 1, 9, n => (a1+n <= 100), 5);
                
                b1 = getSafeRandom(35, 95, n => (n%10 !== 0 && n%10 !== 9), 55);
                let maxB2 = b1%10;
                b2 = getSafeRandom(maxB2 + 1, 9, n => (b1-n >= 0), 6);
            } else {
                a1 = getSafeRandom(15, 60, n => true, 35); 
                a2 = getSafeRandom(11, 29, n => (a1+n <= 100), 15);
                b1 = getSafeRandom(45, 95, n => true, 75);
                b2 = getSafeRandom(11, 29, n => (b1-n >= 5), 15);
            }

            let cls = (currentMode === 'mix') ? 'task-row-mix' : 'task-row-steps';
            let h2 = (currentMode === 'mix') ? '<h2>1. Rechne schrittweise</h2>' : '';
            let wrapperS = `<div class="${cls}" id="S_${id}">${h2}<div style="display:flex; gap:30px;"><div style="flex:1"><div><span class="sub-label">${labelL}</span></div><div class="grid-paper"><div class="grid-text"><input class="live-num" id="in_a1_${id}" value="${a1}"> + <input class="live-num" id="in_a2_${id}" value="${a2}"> =</div></div></div><div style="flex:1"><div><span class="sub-label">${labelR}</span></div><div class="grid-paper"><div class="grid-text"><input class="live-num" id="in_b1_${id}" value="${b1}"> - <input class="live-num" id="in_b2_${id}" value="${b2}"> =</div></div></div></div></div>`;
            let wrapperT = `<div class="${cls}" id="T_${id}">${h2}<div style="display:flex; gap:30px;"><div style="flex:1"><div><span class="sub-label">${labelL}</span></div><div class="grid-paper"><div class="grid-text" id="out_a_${id}"></div></div></div><div style="flex:1"><div><span class="sub-label">${labelR}</span></div><div class="grid-paper"><div class="grid-text" id="out_b_${id}"></div></div></div></div></div>`;
            
            const update = () => {
                const diffMode = document.getElementById('diff-select').value;
                let va1 = parseInt(document.getElementById(`in_a1_${id}`).value)||0; let va2 = parseInt(document.getElementById(`in_a2_${id}`).value)||0;
                let resA = va1+va2, midA, rest;
                if (diffMode === 'easy') {
                    let toTen = (10 - (va1%10))%10; if(toTen>va2) toTen=va2; rest=va2-toTen; midA=va1+toTen;
                    document.getElementById(`out_a_${id}`).innerHTML = `${va1} + ${va2} = <span class="sol">${resA}</span>\n${va1} + ${toTen} = <span class="sol">${midA}</span>\n<span class="sol">${midA}</span> + <span class="sol">${rest}</span> = <span class="sol">${resA}</span>`;
                } else {
                    let tens = Math.floor(va2/10)*10; let ones = va2%10; midA = va1+tens;
                    document.getElementById(`out_a_${id}`).innerHTML = `${va1} + ${va2} = <span class="sol">${resA}</span>\n${va1} + ${tens} = <span class="sol">${midA}</span>\n<span class="sol">${midA}</span> + <span class="sol">${ones}</span> = <span class="sol">${resA}</span>`;
                }
                let vb1 = parseInt(document.getElementById(`in_b1_${id}`).value)||0; let vb2 = parseInt(document.getElementById(`in_b2_${id}`).value)||0;
                let resB = vb1-vb2, midB;
                if (diffMode === 'easy') {
                    let toTen = vb1%10; if(toTen>vb2) toTen=vb2; rest=vb2-toTen; midB=vb1-toTen;
                    document.getElementById(`out_b_${id}`).innerHTML = `${vb1} - ${vb2} = <span class="sol">${resB}</span>\n${vb1} - ${toTen} = <span class="sol">${midB}</span>\n<span class="sol">${midB}</span> - <span class="sol">${rest}</span> = <span class="sol">${resB}</span>`;
                } else {
                    let tens = Math.floor(vb2/10)*10; let ones = vb2%10; midB = vb1-tens;
                    document.getElementById(`out_b_${id}`).innerHTML = `${vb1} - ${vb2} = <span class="sol">${resB}</span>\n${vb1} - ${tens} = <span class="sol">${midB}</span>\n<span class="sol">${midB}</span> - <span class="sol">${ones}</span> = <span class="sol">${resB}</span>`;
                }
            };
            return { student: wrapperS, teacher: wrapperT, registerListeners: () => { [`in_a1_${id}`, `in_a2_${id}`, `in_b1_${id}`, `in_b2_${id}`].forEach(iid => { let el = document.getElementById(iid); if(el) el.addEventListener('input', update); }); update(); }};
        }

        // ========================
        // 2. RECHENSTRICH
        // ========================
        function genLineTask(id, extraSpace, diff, rowIdx) {
            let labelA = (rowIdx === null) ? 'a)' : getLabel(rowIdx * 2, 'practice');
            let labelB = (rowIdx === null) ? 'b)' : getLabel(rowIdx * 2 + 1, 'practice');
            let a1, a2, b1, b2;

            if (diff === 'easy') {
                a1 = getSafeRandom(15, 80, n => (n%10 !== 0 && n%10 !== 1), 25);
                a2 = getSafeRandom(2, 9, n => (n > 10-(a1%10) && a1+n <= 100), 5);
                b1 = getSafeRandom(40, 90, n => (n%10 !== 0 && n%10 !== 9), 55);
                b2 = getSafeRandom(2, 9, n => (n > b1%10 && b1-n >= 0), 6);
            } else {
                a1 = getSafeRandom(15, 60, n=>true, 30); a2 = getSafeRandom(11, 25, n=>(a1+n<=100), 12);
                b1 = getSafeRandom(40, 90, n=>true, 60); b2 = getSafeRandom(11, 25, n=>(b1-n>=0), 12);
            }

            let h2 = (currentMode === 'mix') ? '<h2>2. Zeichne und rechne am Rechenstrich</h2>' : '';
            let cls = (currentMode === 'mix') ? 'task-row-mix' : 'task-row-lines';
            let wrapperS = `<div class="${cls}">${h2}<div class="number-line-box"><div style="font-size:16px; margin-bottom:5px;"><strong>${labelA}</strong> &nbsp; <input class="live-num" id="in_s_a_${id}" value="${a1}"> + <input class="live-num" id="in_d_a_${id}" value="${a2}"> = ____</div><div class="number-line"><div class="tick" style="left: 10%;"></div><div class="tick-label" style="left: 10%;" id="txt_s_a_${id}">${a1}</div></div></div><div class="number-line-box" style="margin-top:10px;"><div style="font-size:16px; margin-bottom:5px;"><strong>${labelB}</strong> &nbsp; <input class="live-num" id="in_s_b_${id}" value="${b1}"> - <input class="live-num" id="in_d_b_${id}" value="${b2}"> = ____</div><div class="number-line"><div class="tick" style="left: 90%;"></div><div class="tick-label" style="left: 90%;" id="txt_s_b_${id}">${b1}</div></div></div></div>`;
            let wrapperT = `<div class="${cls}">${h2}<div id="sol_a_${id}"></div><div id="sol_b_${id}" style="margin-top:10px;"></div></div>`;
            const update = () => {
                const diffMode = document.getElementById('diff-select').value;
                const draw = (sub, startVal, delta, isPlus) => {
                    let txtEl = document.getElementById(`txt_s_${sub}_${id}`);
                    if(txtEl) txtEl.innerText = startVal;
                    let res, mid, step1, step2, w1, w2, pStart, pMid, pEnd;
                    if (isPlus) {
                        res = startVal + delta;
                        if(diffMode === 'easy') { let toTen = (10-(startVal%10))%10; if(toTen>delta) toTen=delta; step1=toTen; step2=delta-step1; } 
                        else { step1 = Math.floor(delta/10)*10; step2 = delta % 10; }
                        mid = startVal + step1; let ratio = (delta===0)?0.5:(step1/delta); w1=80*ratio; if(w1<10) w1=10; if(w1>70) w1=70; w2=80-w1; pStart=10; pMid=10+w1; pEnd=90;
                        document.getElementById(`sol_${sub}_${id}`).innerHTML = `<div class="number-line-box"><div style="font-size:16px; margin-bottom:5px;"><strong>${sub==='a'?labelA:labelB}</strong> &nbsp; ${startVal} + ${delta} = <span class="sol">${res}</span></div><div class="number-line"><div class="tick" style="left:${pStart}%"></div><div class="tick-label" style="left:${pStart}%">${startVal}</div><div class="tick tick-sol" style="left:${pMid}%"></div><div class="tick-label tick-label-sol" style="left:${pMid}%">${mid}</div><div class="tick tick-sol" style="left:${pEnd}%"></div><div class="tick-label tick-label-sol" style="left:${pEnd}%">${res}</div><div class="arc" style="left:${pStart}%; width:${w1}%"><div class="arc-label">+${step1}</div></div><div class="arc" style="left:${pMid}%; width:${w2}%"><div class="arc-label">+${step2}</div></div><div class="arc-big" style="left:${pStart}%; width:80%"><div class="arc-big-label">+${delta}</div></div></div></div>`;
                    } else {
                        res = startVal - delta;
                        if(diffMode === 'easy') { let toTen=startVal%10; if(toTen>delta) toTen=delta; step1=toTen; step2=delta-step1; }
                        else { step1 = Math.floor(delta/10)*10; step2 = delta % 10; }
                        mid = startVal - step1; let ratio = (delta===0)?0.5:(step1/delta); w1=80*ratio; if(w1<10) w1=10; if(w1>70) w1=70; w2=80-w1; pStart=90; pMid=90-w1; pEnd=10;
                        document.getElementById(`sol_${sub}_${id}`).innerHTML = `<div class="number-line-box"><div style="font-size:16px; margin-bottom:5px;"><strong>${sub==='a'?labelA:labelB}</strong> &nbsp; ${startVal} - ${delta} = <span class="sol">${res}</span></div><div class="number-line"><div class="tick" style="left:${pStart}%"></div><div class="tick-label" style="left:${pStart}%">${startVal}</div><div class="tick tick-sol" style="left:${pMid}%"></div><div class="tick-label tick-label-sol" style="left:${pMid}%">${mid}</div><div class="tick tick-sol" style="left:${pEnd}%"></div><div class="tick-label tick-label-sol" style="left:${pEnd}%">${res}</div><div class="arc" style="left:${pMid}%; width:${w1}%"><div class="arc-label">-${step1}</div></div><div class="arc" style="left:${pEnd}%; width:${w2}%"><div class="arc-label">-${step2}</div></div><div class="arc-big" style="left:${pEnd}%; width:80%"><div class="arc-big-label">-${delta}</div></div></div></div>`;
                    }
                };
                let va = parseInt(document.getElementById(`in_s_a_${id}`).value)||0; let da = parseInt(document.getElementById(`in_d_a_${id}`).value)||0; draw('a', va, da, true);
                let vb = parseInt(document.getElementById(`in_s_b_${id}`).value)||0; let db = parseInt(document.getElementById(`in_d_b_${id}`).value)||0; draw('b', vb, db, false);
            };
            return { student: wrapperS, teacher: wrapperT, registerListeners: () => { [`in_s_a_${id}`, `in_d_a_${id}`, `in_s_b_${id}`, `in_d_b_${id}`].forEach(iid => { let el=document.getElementById(iid); if(el) el.addEventListener('input', update); }); update(); }};
        }

        // ========================
        // 3. RECHENMAUERN
        // ========================
        function genWallTask(id, extraSpace, diff, rowIdx) {
            let labels = rowIdx === null ? ['a)', 'b)', 'c)'] : [getLabel(rowIdx*3, 'practice'), getLabel(rowIdx*3+1, 'practice'), getLabel(rowIdx*3+2, 'practice')];
            let walls = []; 
            for(let i=0; i<3; i++) { 
                if (diff === 'easy') walls.push([rand(15, 60), rand(2, 9), rand(1, 5)]); 
                else walls.push([rand(10, 20), rand(10, 20), rand(10, 20)]); 
            }
            let h2 = (currentMode === 'mix') ? '<h2>3. Rechenmauern</h2>' : '';
            let cls = (currentMode === 'mix') ? 'task-row-mix' : 'task-row-walls';
            let sHtml = `<div class="${cls}"><div class="walls-wrapper">`;
            let tHtml = `<div class="${cls}"><div class="walls-wrapper">`;
            if(h2) { sHtml = `<div class="${cls}">${h2}<div class="walls-wrapper">`; tHtml = `<div class="${cls}">${h2}<div class="walls-wrapper">`; }

            let inputIds = [];
            for(let i=0; i<3; i++) {
                let bid1 = `w_${id}_${i}_1`, bid2 = `w_${id}_${i}_2`, bid3 = `w_${id}_${i}_3`;
                let m1id = `w_${id}_${i}_m1`, topid = `w_${id}_${i}_top`;
                inputIds.push({bid1, bid2, bid3, m1id, topid, i});
                
                let variant = Math.random() < 0.5 ? 'gap' : 'standard';
                if (diff === 'easy' && variant === 'gap') walls[i] = [rand(15, 60), rand(1, 5), rand(1, 4)];
                
                let val1 = walls[i][0], val2 = walls[i][1], val3 = walls[i][2];
                let m1 = val1 + val2, m2 = val2 + val3, top = m1 + m2;
                let b1html, b2html, b3html, m1html, m2html, tophtml;

                if (variant === 'gap') {
                    b1html = `<input class="live-num gap-field" id="${bid1}" value="">`;
                    b2html = `<input class="live-num gap-field" id="${bid2}" value="">`;
                    b3html = `<input class="brick-input" id="${bid3}" value="${val3}">`;
                    m1html = `<input class="brick-input" id="${m1id}" value="${m1}">`;
                    m2html = ``; 
                    tophtml = `<input class="brick-input" id="${topid}" value="${top}">`;
                } else {
                    b1html = `<input class="live-num" id="${bid1}" value="${val1}">`;
                    b2html = `<input class="live-num" id="${bid2}" value="${val2}">`;
                    b3html = `<input class="live-num" id="${bid3}" value="${val3}">`;
                    m1html = ``; m2html = ``; tophtml = ``;
                }
                sHtml += `<div class="side-layout"><span class="side-label">${labels[i]}</span><div class="wall"><div class="brick-row"><div class="brick" id="s_top_${id}_${i}">${tophtml}</div></div><div class="brick-row"><div class="brick" id="s_m1_${id}_${i}">${m1html}</div><div class="brick" id="s_m2_${id}_${i}">${m2html}</div></div><div class="brick-row"><div class="brick">${b1html}</div><div class="brick">${b2html}</div><div class="brick">${b3html}</div></div></div></div>`;
                tHtml += `<div class="side-layout"><span class="side-label">${labels[i]}</span><div class="wall"><div class="brick-row"><div class="brick sol" id="t_top_${id}_${i}"></div></div><div class="brick-row"><div class="brick sol" id="t_m1_${id}_${i}"></div><div class="brick sol" id="t_m2_${id}_${i}"></div></div><div class="brick-row"><div class="brick" id="t_b1_${id}_${i}"></div><div class="brick" id="t_b2_${id}_${i}"></div><div class="brick" id="t_b3_${id}_${i}"></div></div></div></div>`;
            }
            sHtml += `</div></div>`; tHtml += `</div></div>`;
            
            const update = () => {
                inputIds.forEach(item => {
                    let b1_el = document.getElementById(item.bid1);
                    let b2_el = document.getElementById(item.bid2);
                    let b3_el = document.getElementById(item.bid3);
                    let m1_el = document.getElementById(item.m1id);
                    let top_el = document.getElementById(item.topid);

                    let isGapMode = (m1_el !== null);

                    if (isGapMode) {
                        let top = top_el ? (parseInt(top_el.value) || 0) : 0;
                        let m1 = m1_el ? (parseInt(m1_el.value) || 0) : 0;
                        let b3_val = b3_el ? (parseInt(b3_el.value) || 0) : 0;
                        
                        let m2_calc = top - m1;
                        let b2_calc = m2_calc - b3_val;
                        let b1_calc = m1 - b2_calc;
                        
                        let elB1 = document.getElementById(`t_b1_${id}_${item.i}`); if(elB1) elB1.innerHTML = `<span class="sol">${b1_calc}</span>`; 
                        let elB2 = document.getElementById(`t_b2_${id}_${item.i}`); if(elB2) elB2.innerHTML = `<span class="sol">${b2_calc}</span>`; 
                        let elB3 = document.getElementById(`t_b3_${id}_${item.i}`); if(elB3) elB3.innerText = b3_val;
                        let elM1 = document.getElementById(`t_m1_${id}_${item.i}`); if(elM1) elM1.innerText = m1; 
                        let elM2 = document.getElementById(`t_m2_${id}_${item.i}`); if(elM2) elM2.innerHTML = `<span class="sol">${m2_calc}</span>`; 
                        let elTop = document.getElementById(`t_top_${id}_${item.i}`); if(elTop) elTop.innerText = top;

                    } else {
                        let b1 = b1_el ? (parseInt(b1_el.value) || 0) : 0;
                        let b2 = b2_el ? (parseInt(b2_el.value) || 0) : 0;
                        let b3 = b3_el ? (parseInt(b3_el.value) || 0) : 0;

                        let m1 = b1 + b2;
                        let m2 = b2 + b3;
                        let top = m1 + m2;
                        
                        let elB1 = document.getElementById(`t_b1_${id}_${item.i}`); if(elB1) elB1.innerText = b1; 
                        let elB2 = document.getElementById(`t_b2_${id}_${item.i}`); if(elB2) elB2.innerText = b2; 
                        let elB3 = document.getElementById(`t_b3_${id}_${item.i}`); if(elB3) elB3.innerText = b3;
                        let elM1 = document.getElementById(`t_m1_${id}_${item.i}`); if(elM1) elM1.innerText = m1; 
                        let elM2 = document.getElementById(`t_m2_${id}_${item.i}`); if(elM2) elM2.innerText = m2; 
                        let elTop = document.getElementById(`t_top_${id}_${item.i}`); if(elTop) elTop.innerText = top;
                    }
                });
            };
            return { student: sHtml, teacher: tHtml, registerListeners: () => { 
                inputIds.forEach(item => {
                    let ids = [item.bid1, item.bid2, item.bid3, item.m1id, item.topid];
                    ids.forEach(x => { if(x && document.getElementById(x)) document.getElementById(x).addEventListener('input', update); });
                });
                update(); 
            }};
        }

        // ========================
        // 4. SYMMETRIE
        // ========================
        function genSymTask(id, extraSpace, diff, rowIdx, headerOverride) {
            let labels = rowIdx === null ? ['a)', 'b)'] : [getLabel(rowIdx*2, 'practice'), getLabel(rowIdx*2+1, 'practice')];
            let h2 = "";
            if (currentMode === 'mix') { h2 = headerOverride ? `<h2>${headerOverride}</h2>` : '<h2>5. Zeichne das Spiegelbild</h2>'; }
            
            let cls = (currentMode === 'mix') ? 'task-row-mix' : 'task-row-sym';
            let extraClass = (rowIdx === 0 && currentMode !== 'mix') ? 'top-margin-large' : '';
            let grids = [[], []];
            for(let k=0; k<2; k++) { for(let r=0; r<6; r++) { let row = []; for(let c=0; c<3; c++) row.push(Math.random()<0.4); grids[k].push(row); }}
            const buildGrid = (k, type) => {
                let h = `<table class="sym-table" id="sym_${type}_${id}_${k}">`;
                for(let r=0; r<6; r++) { h += `<tr>`; for(let c=0; c<3; c++) { let act = grids[k][r][c]?"filled-cell":""; let border = (c===2) ? " axis-border" : ""; let ev = (type==='s') ? `onclick="toggleSym('${id}',${k},${r},${c})"` : ""; h += `<td class="${act}${border}" ${ev} id="cell_${type}_${id}_${k}_${r}_${c}_L"></td>`; } for(let c=0; c<3; c++) { let mC=2-c; let act=(type==='t'&&grids[k][r][mC])?"solution-cell":""; h += `<td class="${act}" id="cell_${type}_${id}_${k}_${r}_${c}_R"></td>`; } h += `</tr>`; }
                return h + `</table>`;
            };
            let sHtml = `<div class="${cls} ${extraClass}">${h2}<div class="sym-wrapper">`;
            let tHtml = `<div class="${cls} ${extraClass}">${h2}<div class="sym-wrapper">`;
            for(let k=0; k<2; k++) {
                sHtml += `<div class="side-layout"><span class="side-label">${labels[k]}</span><div class="sym-box">${buildGrid(k, 's')}</div></div>`;
                tHtml += `<div class="side-layout"><span class="side-label">${labels[k]}</span><div class="sym-box">${buildGrid(k, 't')}</div></div>`;
            }
            return { student: sHtml + `</div></div>`, teacher: tHtml + `</div></div>` };
        }

        window.toggleSym = function(id, k, r, c) {
            let cellS = document.getElementById(`cell_s_${id}_${k}_${r}_${c}_L`);
            let isFilled = cellS.classList.toggle('filled-cell');
            let mC = 2 - c;
            let cellT = document.getElementById(`cell_t_${id}_${k}_${r}_${mC}_R`);
            if(isFilled) cellT.classList.add('solution-cell'); else cellT.classList.remove('solution-cell');
            let cellTL = document.getElementById(`cell_t_${id}_${k}_${r}_${c}_L`);
            if(isFilled) cellTL.classList.add('filled-cell'); else cellTL.classList.remove('filled-cell');
        }

        // ========================
        // 5. TEXTAUFGABEN
        // ========================
        function genStoryTask(id, extraSpace, diff, rowIdx, pool, headerText, labelOverride, gridHeightOverride) {
            let label = (labelOverride) ? `<span class="side-label" style="float:left;">${labelOverride}</span>` : ((rowIdx !== null) ? `<span class="side-label" style="float:left;">${getLabel(rowIdx, 'practice')}</span>` : "");
            if (pool.length === 0) pool = [...ALL_STORIES];
            let index = rand(0, pool.length-1); let s = pool[index]; pool.splice(index, 1);
            let nA, nB;
            let h2 = "";
            if (currentMode === 'mix') { if(headerText) h2 = `<h2>${headerText}</h2>`; }
            
            if (diff === 'easy') {
                nA = rand(20, 80); nB = rand(5, 19);
                if(s.op === '+') {
                    nA = getSafeRandom(20, 80, n => (n%10!==0 && n%10!==1), 45);
                    nB = getSafeRandom(5, 9, n => (nA+n<=100), 5);
                } else {
                    nA = getSafeRandom(20, 80, n => (n%10!==0 && n%10!==9), 45);
                    nB = getSafeRandom(5, 9, n => (nA-n>=10), 5);
                }
            } else {
                if(s.op === '+') { nA = getSafeRandom(15, 60, n => true, 30); nB = getSafeRandom(11, 39, n => (nA+n<=100), 12); } 
                else { nA = getSafeRandom(45, 95, n => true, 60); nB = getSafeRandom(11, 35, n => (nA-n>=5), 15); }
            }
            let gridHeight = gridHeightOverride || '60px'; 
            let cls = (currentMode === 'mix') ? 'task-row-mix story-wrapper' : 'task-row-story story-wrapper';
            if (currentMode !== 'mix') gridHeight = '90px';

            let textHtml = s.t.replace("{A}", `<input class="live-num story-input" id="in_sa_${id}" value="${nA}">`).replace("{B}", `<input class="live-num story-input" id="in_sb_${id}" value="${nB}">`);
            let sHtml = `<div class="${cls}">${h2}<div>${label}<div class="story-text">${textHtml}</div></div><div style="clear:both;"></div><div class="label-small">Rechnung:</div><div class="grid-paper" style="height:${gridHeight}; margin-bottom:5px;"></div><div class="label-small">Antwort:</div><div style="border-bottom: 2px dotted #000; height: 25px;"></div></div>`;
            let tHtml = `<div class="${cls}">${h2}<div>${label}<div class="story-text" id="txt_t_${id}"></div></div><div style="clear:both;"></div><div class="label-small">Rechnung:</div><div class="grid-paper" style="height:${gridHeight}; margin-bottom:5px;"><div class="grid-text" style="color:var(--sol-color); line-height:26px; top:2px;" id="sol_calc_${id}"></div></div><div class="label-small">Antwort:</div><div style="border-bottom: 2px dotted #000; height: 25px;"><span class="answer-sol-text" id="sol_ans_${id}"></span></div></div>`;
            const update = () => {
                let vA = parseInt(document.getElementById(`in_sa_${id}`).value)||0; let vB = parseInt(document.getElementById(`in_sb_${id}`).value)||0;
                let res, opChar = s.op; if(s.op==='+') res=vA+vB; else res=vA-vB;
                document.getElementById(`txt_t_${id}`).innerHTML = s.t.replace("{A}", vA).replace("{B}", vB);
                let diffMode = document.getElementById('diff-select').value; let solText = `${vA} ${opChar} ${vB} = ${res}`;
                if (diffMode === 'hard') {
                    let tB = Math.floor(vB/10)*10; let oB = vB%10;
                    if(s.op === '+') solText += `\n${vA} + ${tB} = ${vA+tB}\n${vA+tB} + ${oB} = ${res}`;
                    else solText += `\n${vA} - ${tB} = ${vA-tB}\n${vA-tB} - ${oB} = ${res}`;
                } else {
                    if(s.op === '+') { let toTen = (10 - vA%10)%10; if(toTen>vB) toTen=vB; let rest = vB-toTen; solText += `\n${vA} + ${toTen} = ${vA+toTen}\n${vA+toTen} + ${rest} = ${res}`; }
                    else { let toTen = vA%10; if(toTen>vB) toTen=vB; let rest = vB-toTen; solText += `\n${vA} - ${toTen} = ${vA-toTen}\n${vA-toTen} - ${rest} = ${res}`; }
                }
                document.getElementById(`sol_calc_${id}`).innerText = solText;
                let verb = (s.op === "+") ? "Es sind jetzt" : "Es sind noch"; if(s.t.includes("bleiben √ºbrig")) verb = "Es bleiben";
                document.getElementById(`sol_ans_${id}`).innerText = `${verb} ${res} ${s.u}.`;
            };
            return { student: sHtml, teacher: tHtml, registerListeners: () => { document.getElementById(`in_sa_${id}`).addEventListener('input', update); document.getElementById(`in_sb_${id}`).addEventListener('input', update); update(); }};
        }

        // ========================
        // 6. KOPFRECHNEN
        // ========================
        function genMentalTask(id, extraSpace, diff, rowIdx, countOverride) {
            let count = countOverride || 32; let packetSize = 4;
            let sHtml = `<div class="top-margin-large packet-container">`;
            let tHtml = `<div class="top-margin-large packet-container">`;
            let inputIds = [];
            let data = [];
            for(let i=0; i<count; i++) {
                let op = Math.random() < 0.5 ? '+' : '-';
                let a, b;
                if(diff === 'easy') {
                    if(op === '+') { a = rand(12, 80); b = getSafeRandom(1, 9, n => (a+n<=100), 1); }
                    else { a = rand(25, 92); b = getSafeRandom(1, 9, n => (a-n>=0), 1); }
                } else {
                    if(op === '+') { a = rand(15, 60); b = getSafeRandom(11, 39, n => (a+n<=100), 12); } 
                    else { a = rand(35, 95); b = getSafeRandom(11, 35, n => (a-n>=2), 11); }
                }
                data.push({a, b, op, idx: i});
            }
            for(let p=0; p<count; p+=packetSize) {
                let packetLabel = getLabel(p/packetSize, 'practice');
                sHtml += `<div class="packet"><div class="packet-label">${packetLabel}</div>`;
                tHtml += `<div class="packet"><div class="packet-label">${packetLabel}</div>`;
                for(let i=p; i<p+packetSize && i<count; i++) {
                    let d = data[i];
                    let idA = `m_a_${id}_${d.idx}`, idB = `m_b_${id}_${d.idx}`, idRes = `m_res_${id}_${d.idx}`;
                    inputIds.push({idA, idB, idRes, op: d.op, idx: d.idx});
                    sHtml += `<div class="packet-item"><input class="live-num wide-input" id="${idA}" value="${d.a}"> ${d.op} <input class="live-num wide-input" id="${idB}" value="${d.b}"> = <input class="gap-input" value=""></div>`;
                    tHtml += `<div class="packet-item" id="t_mental_line_${id}_${d.idx}"></div>`;
                }
                sHtml += `</div>`; tHtml += `</div>`;
            }
            sHtml += `</div>`; tHtml += `</div>`;
            const update = () => {
                 inputIds.forEach(item => {
                     let vA = parseInt(document.getElementById(item.idA).value)||0;
                     let vB = parseInt(document.getElementById(item.idB).value)||0;
                     let res = (item.op === '+') ? vA + vB : vA - vB;
                     let solString = `${vA} ${item.op} ${vB} = <span class="sol">${res}</span>`;
                     document.getElementById(`t_mental_line_${id}_${item.idx}`).innerHTML = solString;
                 });
            };
            return { student: sHtml, teacher: tHtml, registerListeners: () => { inputIds.forEach(item => { document.getElementById(item.idA).addEventListener('input', update); document.getElementById(item.idB).addEventListener('input', update); }); update(); } };
        }

        // ========================
        // 7. L√úCKENAUFGABEN
        // ========================
        function genGapTask(id, extraSpace, diff, rowIdx, countOverride) {
            let count = countOverride || 24; let packetSize = 5; 
            let sHtml = `<div class="top-margin-large packet-container">`;
            let tHtml = `<div class="top-margin-large packet-container">`;
            let inputIds = [];
            let data = [];
            for(let i=0; i<count; i++) {
                let op = Math.random() < 0.5 ? '+' : '-';
                let a, b, res;
                let gapPos = Math.random() < 0.5 ? 1 : 2; 
                if(diff === 'easy') {
                    if(op === '+') { a = rand(12, 80); b = getSafeRandom(1, 9, n=>(a+n<=100), 2); res = a + b; } 
                    else { a = rand(25, 92); b = getSafeRandom(1, 9, n=>(a-n>=0), 2); res = a - b; }
                } else {
                    if(op === '+') { a = rand(15, 60); b = getSafeRandom(11, 39, n=>(a+n<=100), 12); res = a + b; } 
                    else { a = rand(35, 95); b = getSafeRandom(11, 35, n=>(a-n>=2), 12); res = a - b; }
                }
                data.push({a, b, res, op, gapPos, idx: i});
            }
            for(let p=0; p<count; p+=packetSize) {
                let packetLabel = getLabel(p/packetSize, 'practice');
                sHtml += `<div class="packet"><div class="packet-label">${packetLabel}</div>`;
                tHtml += `<div class="packet"><div class="packet-label">${packetLabel}</div>`;
                for(let i=p; i<p+packetSize && i<count; i++) {
                    let d = data[i];
                    let idA = `g_a_${id}_${d.idx}`, idB = `g_b_${id}_${d.idx}`, idRes = `g_res_${id}_${d.idx}`;
                    inputIds.push({idA, idB, idRes, op: d.op, idx: d.idx, gapPos: d.gapPos});
                    sHtml += `<div class="packet-item">`;
                    tHtml += `<div class="packet-item" id="t_gap_line_${id}_${d.idx}">`;
                    let inputA, inputB, inputRes;
                    if(d.gapPos === 1) {
                         inputA = `<input class="gap-input gap-field" id="${idA}" value="">`;
                         inputB = `<input class="live-num wide-input" id="${idB}" value="${d.b}">`;
                         inputRes = `<input class="live-num wide-input" id="${idRes}" value="${d.res}">`;
                    } else {
                         inputA = `<input class="live-num wide-input" id="${idA}" value="${d.a}">`;
                         inputB = `<input class="gap-input gap-field" id="${idB}" value="">`;
                         inputRes = `<input class="live-num wide-input" id="${idRes}" value="${d.res}">`;
                    }
                    sHtml += `${inputA} ${d.op} ${inputB} = ${inputRes}</div>`;
                    tHtml += `</div>`; 
                }
                sHtml += `</div>`; tHtml += `</div>`;
            }
            sHtml += `</div>`; tHtml += `</div>`;
            const update = () => {
                inputIds.forEach(item => {
                    let vA_el = document.getElementById(item.idA);
                    let vB_el = document.getElementById(item.idB);
                    let vRes_el = document.getElementById(item.idRes);
                    let vA = parseInt(vA_el.value);
                    let vB = parseInt(vB_el.value);
                    let vRes = parseInt(vRes_el.value);
                    let solString = "";
                    if(item.gapPos === 1) {
                        let gap = (item.op === '+') ? (vRes - vB) : (vRes + vB);
                        if(isNaN(gap)) gap = "?";
                        solString = `<span class="sol">${gap}</span> ${item.op} ${vB || '?'} = ${vRes || '?'}`;
                    } else {
                        let gap = (item.op === '+') ? (vRes - vA) : (vA - vRes);
                        if(isNaN(gap)) gap = "?";
                        solString = `${vA || '?'} ${item.op} <span class="sol">${gap}</span> = ${vRes || '?'}`;
                    }
                    document.getElementById(`t_gap_line_${id}_${item.idx}`).innerHTML = solString;
                });
            };
            return { student: sHtml, teacher: tHtml, registerListeners: () => { 
                inputIds.forEach(item => { 
                    document.getElementById(item.idA).addEventListener('input', update); 
                    document.getElementById(item.idB).addEventListener('input', update);
                    document.getElementById(item.idRes).addEventListener('input', update);
                }); 
                update(); 
            }};
        }

        function updateTestNumber() { let s = localStorage.getItem('flexFloTestNr'); currentNr = s ? parseInt(s)+1 : 1; localStorage.setItem('flexFloTestNr', currentNr); document.querySelectorAll('.test-nr-display').forEach(d => d.innerText = currentNr); }
        function loadInitialNumber() { let s = localStorage.getItem('flexFloTestNr'); currentNr = s ? parseInt(s) : 1; document.querySelectorAll('.test-nr-display').forEach(d => d.innerText = currentNr); }
        function resetCounter() { if(confirm("Z√§hler auf 1 setzen?")) { localStorage.setItem('flexFloTestNr', 0); generateCurrent(true); } }

        // INIT
        loadInitialNumber();
        document.getElementById('page-student-2').classList.remove('hidden-page');
        document.getElementById('page-solution-2').classList.remove('hidden-page');
        generateCurrent(false); 
    </script>
</body>
</html>
